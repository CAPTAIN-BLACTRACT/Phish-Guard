rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ─────────────────────────────────────────────────────────────
    // Helper functions
    // ─────────────────────────────────────────────────────────────
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(uid) {
      return isSignedIn() && request.auth.uid == uid;
    }

    function validUserFields() {
      return request.resource.data.keys().hasOnly([
        'uid', 'displayName', 'email', 'photoURL',
        'xp', 'level', 'streak', 'lastActive',
        'badges', 'createdAt'
      ]);
    }

    // ─────────────────────────────────────────────────────────────
    // USERS  /users/{uid}
    // ─────────────────────────────────────────────────────────────
    match /users/{uid} {
      // Any authenticated user can read public profiles
      allow read: if isSignedIn();

      // Only the owner can create their own doc
      allow create: if isOwner(uid) && validUserFields();

      // Only the owner can update (cannot change uid or createdAt)
      allow update: if isOwner(uid)
        && !('uid'       in request.resource.data.diff(resource.data).affectedKeys())
        && !('createdAt' in request.resource.data.diff(resource.data).affectedKeys());

      // Nobody can delete user docs through client SDK
      allow delete: if false;
    }

    // ─────────────────────────────────────────────────────────────
    // QUIZ RESULTS  /quizResults/{docId}
    // ─────────────────────────────────────────────────────────────
    match /quizResults/{docId} {
      // User can read only their own results
      allow read: if isSignedIn() && resource.data.uid == request.auth.uid;

      // Authenticated user can create a result for themselves
      allow create: if isSignedIn()
        && request.resource.data.uid == request.auth.uid
        && request.resource.data.keys().hasAll(['uid', 'score', 'total', 'xpEarned', 'completedAt']);

      // Results are immutable once written
      allow update, delete: if false;
    }

    // ─────────────────────────────────────────────────────────────
    // SIMULATOR LOGS  /simulatorLogs/{docId}
    // ─────────────────────────────────────────────────────────────
    match /simulatorLogs/{docId} {
      allow read: if isSignedIn() && resource.data.uid == request.auth.uid;

      allow create: if isSignedIn()
        && request.resource.data.uid == request.auth.uid
        && request.resource.data.keys().hasAll(['uid', 'scenarioId', 'detected', 'attemptedAt']);

      allow update, delete: if false;
    }

    // ─────────────────────────────────────────────────────────────
    // LEADERBOARD  /leaderboard/{uid}
    // Public read, owner write only, never delete
    // ─────────────────────────────────────────────────────────────
    match /leaderboard/{uid} {
      // Anyone (even anonymous) can view the leaderboard
      allow read: if true;

      // Only the matching user can write their own leaderboard entry
      allow write: if isOwner(uid);

      allow delete: if false;
    }

    // ─────────────────────────────────────────────────────────────
    // GALLERY  /gallery/{docId}
    // ─────────────────────────────────────────────────────────────
    match /gallery/{docId} {
      // Anyone signed-in can view gallery entries
      allow read: if isSignedIn();

      // Authenticated user can submit a new entry for themselves
      allow create: if isSignedIn()
        && request.resource.data.uid == request.auth.uid
        && request.resource.data.keys().hasAll(['uid', 'title', 'description', 'submittedAt']);

      // Owner can update their own entry; anyone signed-in can increment likes only
      allow update: if isSignedIn() && (
        // Owner: full update rights
        resource.data.uid == request.auth.uid
        ||
        // Others: only the 'likes' field may change (and only by +1)
        (
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes'])
          && request.resource.data.likes == resource.data.likes + 1
        )
      );

      // Only the owner can delete their own entry
      allow delete: if isSignedIn() && resource.data.uid == request.auth.uid;
    }

    // ─────────────────────────────────────────────────────────────
    // Catch-all – deny everything else
    // ─────────────────────────────────────────────────────────────
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
